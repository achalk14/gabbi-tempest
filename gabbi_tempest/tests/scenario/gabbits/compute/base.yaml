
defaults:
    request_headers:
        x-auth-token: $ENVIRON['SERVICE_TOKEN']

# NOTE(cdent): The use of complex JSONPath to determine URLs is bad
# for readability. 

tests:

- name: retrieve root
  GET: $ENVIRON['COMPUTE_SERVICE']/
  response_json_paths:
      # $NETLOC contains the /v2.1 prefix
      $.version.links[?rel = "self"].href: /$ENVIRON['COMPUTE_SERVICE']/
      $.version.status: CURRENT

- name: retrieve empty servers
  GET: $ENVIRON['COMPUTE_SERVICE']/servers
  response_json_paths:
      $.servers: []

- name: try bad accept
  desc: https://bugs.launchpad.net/nova/+bug/1567966
  xfail: True
  GET: $ENVIRON['COMPUTE_SERVICE']/servers
  request_headers:
      accept: text/plain
  status: 406

- name: try bad method
  desc: https://bugs.launchpad.net/nova/+bug/1567970
  xfail: True
  DELETE: $ENVIRON['COMPUTE_SERVICE']/servers
  status: 405

- name: post bad content-type
  desc: https://bugs.launchpad.net/nova/+bug/1567977
  xfail: True
  POST: $ENVIRON['COMPUTE_SERVICE']/servers
  request_headers:
      content-type: text/plain
  data: I want a server so badly
  status: 415

- name: create server
  POST: $ENVIRON['COMPUTE_SERVICE']/servers
  request_headers:
      content-type: application/json
  data:
      server:
          name: new-server-one
          imageRef: $ENVIRON['IMAGE_REF']
          flavorRef: $ENVIRON['FLAVOR_REF']
  status: 202
  response_headers:
      location: //servers/[a-f0-9-]+/

- name: wait for the server to be done
  GET: $LOCATION
  request_headers:
      content-type: application/json
  poll:
      count: 10
      delay: .5
  response_json_paths:
      $.server.status: ACTIVE

# bookmark link, whatever it is, is busted. Goes to bad version
# - name: get bookmark
#   GET: $ENVIRON['COMPUTE_SERVICE']/$RESPONSE['$.server.links[?rel = "bookmark"].href']

- name: get server
  GET: $RESPONSE['$.server.links[?rel = "self"].href']
  response_json_paths:
      $.server.name: new-server-one
